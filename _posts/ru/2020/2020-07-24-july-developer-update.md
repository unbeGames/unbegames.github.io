---
author: Arugin
title: "Дневник разработки: июль"
description: Свет в конце тоннеля
date: 2020-07-24 21:00:00 +0300
categories: [Rocket Science, Дневник разработки]
tags: [rocket science]
image: https://clan.akamai.steamstatic.com/images/34094219/410c6f6d1af98c1a43df3879236eb81a25ed6a16_400x225.png
game: Rocket Science
---
Привет, ребята.

Я наконец-то закончил работать над предсказанием энкаунтеров и вот как это выглядит:

![](https://media3.giphy.com/media/IzciY98lZkQMI6DZzm/giphy.gif)

Технически, предсказание энкаунтера — это просто поиск корня функции расстояния. Но непосредственно сам расчет расстояния между двумя небесными телами в определенный момент времени — достаточно дорогая операция, поэтому не все существующие методы матанализа применимы для решения этой проблемы. Изначально я пробовал аппроксимировать функцию расстояния полиномом Чебышева, после чего искать его действительные корни, используя собственные числа сопровождающей матрицы коэффициентов Чебышева. Это звучит сложно (так и оказалось), но по скорости вычислений это самый быстрый метод. Однако то ли из-за масштабов Солнечной системы, то ли из-за отсутствия необходимого опыта в матанализе, он выдавал недостаточно точные результаты, а иногда даже не мог найти некоторые энкаунтеры, когда они совершенно точно должны были произойти.

Поэтому я забросил этот подход и выбрал более простой, но в то же время и более дорогой метод. Вначале я ищу максимальное приближение корабля к искомому телу на половине орбитального периода, используя метод золотого сечения. Если полученное значение находится внутри сферы влияния небесного тела, тогда я вычисляю несколько итераций метода бисекции, чтобы подобраться ближе к самому энкаунтеру. И чтобы получить финальный, точный результат, я улучшаю расчеты методом Ньютона. Вся эта комбинация работает отлично, и так как почти все вычисления, связанные с орбитами, происходят параллельно, поиск энкаунтеров никак не отражается на производительности игры. Но так как я не математик и не физик, у меня ушло на исследование этой проблемы, эксперименты и поиск решения почти половина июня.

Но оказалось, что это только начало приключения. Я совершенно забыл о разных системах отсчета во время предсказания энкаунтеров. Например, если мы пытаемся перелететь с Земли на Луну и предсказанная орбита попадет в сферу влияния спутника, недостаточно просто отрисовать орбиту. Так как Луна вращается вокруг Земли в такой системе, каждая точка орбиты, ее узлы и маневры на ней, должны быть перенесены относительно этого движения в будущем.


![](https://clan.akamai.steamstatic.com/images//34094219/0527348e0305d8ff0d340a39eb8237569df9e273.png)
_Вне системы отсчета Земли_

![](https://clan.akamai.steamstatic.com/images//34094219/e085ad330b873feacb63aab872eb73ef022a6fb4.png)
_В системе отсчета Земли_

Я называю это динамической системой отсчета. И она работает только для параболических и гиперболических орбит, потому что у них есть точки начала и конца. Для эллиптических орбит нужно смещать только начало координат.

![](https://media1.giphy.com/media/QAg3cCelUeYVAAte7w/giphy.gif)

И если на эллиптическую орбиту поставить маневр, статическая система отсчета должна смениться динамической.

![](https://media0.giphy.com/media/RfNDthTrL0fWg6SxDL/giphy.gif)

Поиск энкаунтеров производится каждый раз, когда космический корабль пролетает через узел маневра. Таким образом вы можете поставить маневр, получить предсказанную траекторию и просто ждать, когда энкаунтер произойдет.

![](https://media1.giphy.com/media/RMeMOcWsfmHsX8DfIl/giphy.gif)

Через некоторое время непрерывного исправления тонны багов и граничных случаев, я обнаружил, что в этой системе отсутствуют еще многие вещи. Например, отображение позиций тел во время энкаунтера, система целей, ноды восходящего и нисходящего узлов, больше всплывающих подсказок с полезной информацией об объектах, интерфейс для более точного изменения характеристической скорости орбитального маневра (в английском просто delta-V =/), и в конце концов соединить это всё с системой полетов. К этому моменту я немного устал от разработки орбит и решил переключиться на другие задачи. Так как того, что я сделал, уже достаточно для достижения Луны, я планирую только соединить систему маневров с полетами и горизонтом к следующему релизу, а все остальные фичи, которых не хватает, перейдут на один из последующих апдейтов.

Я наконец-то мог начать работать над чем-то другим. В первую очередь я поменял карту температур, которую использовал для процедурного текстурирования Земли. Я взял исходные L3 датасеты со спутников TERRA/MODIS и AQUA/MODDIS на сайте NASA в более высоком разрешении, соединил их, обработал так, чтобы заполнить районы с отсутствующей информацией и конвертировал в 16-битную карту температур. По сравнению с 8-битной картой, это сильно улучшило процедурное текстурирование. Переходы между биомами стали более плавными, пропали артефакты и зашумленность, а также текстурирование стало чуть более реалистичным. Больше нет песчаных пустынь в центре Сибири.

![](https://clan.akamai.steamstatic.com/images//34094219/589a043cf35015de9a9a3edd0a262cc87f4314ed.png)
_До_

![](https://clan.akamai.steamstatic.com/images//34094219/2b2463762c1fd7d05d5e6cef7ff719f55034dadc.png)
_После_

Мне все еще нужно улучшить материалы Земли, подобрав их заново и настроив кучу параметров. Но это большая задача, которая не сильно нужна сейчас, так что я вернусь к ней позже.

Следующей задачей была Луна. И, как я упоминал в релизном посте, карта высот Луны уже есть в игре. Но пачка багов блокировала ее загрузку.

![](https://clan.akamai.steamstatic.com/images//34094219/3e95297bc5ea6a1ac2b53a69e991cced7be2d487.png)
_У Луны сейчас нет текстур, но она всё равно выглядит великолепно_

Я использую карту высот разрешением в 32 000 на 16 000 пикселей. И не смотря на то, что площадь Луны в 13 раз меньше площади Земли, этого всё еще недостаточно для хорошего уровня детализации. Мне нужно было написать подходящую функцию шума, чтобы добавить недостающих деталей.

![](https://clan.akamai.steamstatic.com/images//34094219/77d2a07e448a6f7eabb1f1d70a9af1b207a4dfbd.png)
_Когда немного переборщил с шумом_

После этого я переключился на исправление и улучшение межпланетных перелетов. Это было не настолько сложно, как с орбитами, но все еще нужно правильно загружать в память и выгружать из нее планеты, карты высот и столкновения для них, менять атмосферы, а также вычистить все предположения из кода игры о том, что существует только одно небесное тело, вокруг которого можно летать.

Сейчас я заканчиваю написание функции шума для Луны и начинаю работать над ее текстурами. Так как на Луне нет климата, мне нужно будет изменить подход к процедурному текстурированию и в том числе подобрать подходящие материалы.

Что касается даты релиза обновления, я снова переместил ее, в этот раз на конец августа, за что приношу извинения. Я достиг хорошего прогресса в разработке игры за последний месяц, но есть еще куча вещей, которые нужно сделать. После того, как я закончу с Луной, я начну создавать новые детали ракет. Некоторые из них будет очень просто добавить, другие (как парашют) не очень. Также было бы неплохо сделать редизайн некоторых готовых деталей. Но я попробую менять скоуп на протяжении следующего месяца и выбирать только самые важные задачи, чтобы у меня была возможность выпустить обновление, даже если не всё, что я хотел, будет в нем.

Спасибо, и надеюсь, увидимся уже в следующем обновлении.
